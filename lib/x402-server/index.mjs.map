{"version":3,"sources":["../../src/utils/helpers.ts","../../src/server/facilitator-client.ts","../../src/server/payment-handler.ts"],"names":[],"mappings":"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","file":"index.mjs","sourcesContent":["import { VersionedTransaction } from \"@solana/web3.js\";\nimport { PaymentRequirements, SolanaNetwork, SPLTokenAmount } from \"../types\";\n\n/**\n * Helper utilities for x402 payment processing\n */\n\n/**\n * Create payment header from a signed transaction\n * Encodes transaction and payment details into base64 X-PAYMENT header\n */\nexport function createPaymentHeaderFromTransaction(\n  transaction: VersionedTransaction,\n  paymentRequirements: PaymentRequirements,\n  x402Version: number\n): string {\n  // Serialize the signed transaction\n  const serializedTransaction = Buffer.from(transaction.serialize()).toString(\"base64\");\n\n  // Create payment payload matching x402 spec\n  const paymentPayload = {\n    x402Version: x402Version,\n    scheme: paymentRequirements.scheme,\n    network: paymentRequirements.network,\n    payload: {\n      transaction: serializedTransaction,\n    },\n  };\n\n  // Encode payment payload as base64 for X-PAYMENT header\n  const paymentHeader = Buffer.from(JSON.stringify(paymentPayload)).toString(\"base64\");\n\n  return paymentHeader;\n}\n\n/**\n * Get default RPC URL for a given Solana network\n * @param network - Must be 'solana' or 'solana-devnet'\n * @returns Default RPC URL for the network\n */\nexport function getDefaultRpcUrl(network: SolanaNetwork): string {\n  if (network === \"solana\") {\n    return \"https://api.mainnet-beta.solana.com\";\n  } else if (network === \"solana-devnet\") {\n    return \"https://api.devnet.solana.com\";\n  }\n  // TypeScript ensures network is one of the two options, so this is unreachable\n  throw new Error(`Unexpected network: ${network}`);\n}\n\n/**\n * Get default SPL token asset for a given Solana network\n * Defaults to USDC, returns x402-compatible SPLTokenAmount['asset']\n */\nexport function getDefaultTokenAsset(network: SolanaNetwork): SPLTokenAmount['asset'] {\n  if (network === \"solana\") {\n    return {\n      address: \"EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v\",\n      decimals: 6,\n    };\n  } else if (network === \"solana-devnet\") {\n    return {\n      address: \"4zMMC9srt5Ri5X14GAgXhaHii3GnPAEERYPJgZJDncDU\",\n      decimals: 6,\n    };\n  }\n  // TypeScript ensures network is one of the two options, so this is unreachable\n  throw new Error(`Unexpected network: ${network}`);\n}\n\n/**\n * Convert human-readable amount to token's smallest unit (atomic units)\n * @param amount - Human-readable amount (e.g., 2.5 for 2.5 USDC)\n * @param decimals - Token decimals (e.g., 6 for USDC, 9 for SOL)\n */\nexport function toAtomicUnits(amount: number, decimals: number): bigint {\n  return BigInt(Math.floor(amount * Math.pow(10, decimals)));\n}\n\n/**\n * Convert token's atomic units to human-readable amount\n * @param atomicUnits - Token amount in smallest units\n * @param decimals - Token decimals (e.g., 6 for USDC, 9 for SOL)\n */\nexport function fromAtomicUnits(atomicUnits: bigint | number, decimals: number): number {\n  return Number(atomicUnits) / Math.pow(10, decimals);\n}\n\n// Legacy USDC-specific helpers (deprecated, use toAtomicUnits/fromAtomicUnits instead)\n/** @deprecated Use toAtomicUnits(amount, 6) instead */\nexport function usdToMicroUsdc(usdAmount: number): number {\n  return Math.floor(usdAmount * 1_000_000);\n}\n\n/** @deprecated Use fromAtomicUnits(microUsdc, 6) instead */\nexport function microUsdcToUsd(microUsdc: number): number {\n  return microUsdc / 1_000_000;\n}\n\n","import {\n  PaymentRequirements,\n  VerifyResponse,\n  SettleResponse,\n  SupportedPaymentKindsResponse,\n  SupportedPaymentKind,\n} from \"../types\";\n\ntype SupportedPaymentKindType = SupportedPaymentKind;\n\n/**\n * Client for communicating with x402 facilitator service\n */\nexport class FacilitatorClient {\n  constructor(private facilitatorUrl: string) { }\n\n  /**\n   * Get fee payer address from facilitator's /supported endpoint\n   */\n  async getFeePayer(network: string): Promise<string> {\n    const response = await fetch(`${this.facilitatorUrl}/supported`);\n    if (!response.ok) {\n      throw new Error(`Facilitator /supported returned ${response.status}`);\n    }\n\n    const supportedData: SupportedPaymentKindsResponse = await response.json();\n\n    // Look for network support and extract fee payer\n    const networkSupport = supportedData.kinds?.find(\n      (kind: SupportedPaymentKindType) => kind.network === network && kind.scheme === \"exact\"\n    );\n\n    if (!networkSupport?.extra?.feePayer) {\n      throw new Error(\n        `Facilitator does not support network \"${network}\" with scheme \"exact\" or feePayer not provided`\n      );\n    }\n\n    return networkSupport.extra.feePayer;\n  }\n\n  /**\n   * Verify payment with facilitator\n   * @returns VerifyResponse with isValid and optional invalidReason from facilitator\n   */\n  async verifyPayment(\n    paymentHeader: string,\n    paymentRequirements: PaymentRequirements\n  ): Promise<VerifyResponse> {\n    try {\n      // Decode the base64 payment payload\n      const paymentPayload = JSON.parse(\n        Buffer.from(paymentHeader, \"base64\").toString(\"utf8\")\n      );\n\n      const verifyPayload = {\n        paymentPayload,\n        paymentRequirements,\n      };\n\n      const response = await fetch(`${this.facilitatorUrl}/verify`, {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n        },\n        body: JSON.stringify(verifyPayload),\n      });\n\n      if (!response.ok) {\n        const errorBody = await response.text();\n        console.error(`Facilitator /verify returned ${response.status}:`, errorBody);\n        return {\n          isValid: false,\n          invalidReason: \"unexpected_verify_error\",\n        };\n      }\n\n      // Facilitator returns VerifyResponse with status 200 even when validation fails\n      const facilitatorResponse: VerifyResponse = await response.json();\n      return facilitatorResponse;\n    } catch (error) {\n      console.error(\"Payment verification failed:\", error);\n      return {\n        isValid: false,\n        invalidReason: \"unexpected_verify_error\",\n      };\n    }\n  }\n\n  /**\n   * Settle payment with facilitator\n   * @returns SettleResponse with success status and optional errorReason from facilitator\n   */\n  async settlePayment(\n    paymentHeader: string,\n    paymentRequirements: PaymentRequirements\n  ): Promise<SettleResponse> {\n    try {\n      // Decode the base64 payment payload\n      const paymentPayload = JSON.parse(\n        Buffer.from(paymentHeader, \"base64\").toString(\"utf8\")\n      );\n\n      const settlePayload = {\n        paymentPayload,\n        paymentRequirements,\n      };\n\n      const response = await fetch(`${this.facilitatorUrl}/settle`, {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n        },\n        body: JSON.stringify(settlePayload),\n      });\n\n      if (!response.ok) {\n        const errorBody = await response.text();\n        console.error(`Facilitator /settle returned ${response.status}:`, errorBody);\n        return {\n          success: false,\n          errorReason: \"unexpected_settle_error\",\n          transaction: \"\",\n          network: paymentRequirements.network,\n        };\n      }\n\n      // Facilitator returns SettleResponse with status 200 even when settlement fails\n      const facilitatorResponse: SettleResponse = await response.json();\n      return facilitatorResponse;\n    } catch (error) {\n      console.error(\"Payment settlement failed:\", error);\n      return {\n        success: false,\n        errorReason: \"unexpected_settle_error\",\n        transaction: \"\",\n        network: paymentRequirements.network,\n      };\n    }\n  }\n}\n\n","import { X402ServerConfig, PaymentRequirements, RouteConfig, SPLTokenAmount, VerifyResponse, SettleResponse } from \"../types\";\nimport { getDefaultRpcUrl, getDefaultTokenAsset } from \"../utils\";\nimport { FacilitatorClient } from \"./facilitator-client\";\n\n/**\n * x402 Payment Handler for server-side payment processing\n * Framework agnostic - works with any Node.js HTTP framework\n */\ninterface InternalConfig {\n  network: X402ServerConfig['network'];\n  treasuryAddress: string;\n  facilitatorUrl: string;\n  rpcUrl: string;\n  defaultToken: SPLTokenAmount['asset'];\n  middlewareConfig?: X402ServerConfig['middlewareConfig'];\n}\n\nexport class X402PaymentHandler {\n  private facilitatorClient: FacilitatorClient;\n  private config: InternalConfig;\n\n  constructor(config: X402ServerConfig) {\n    const defaultToken = getDefaultTokenAsset(config.network);\n\n    this.config = {\n      network: config.network,\n      treasuryAddress: config.treasuryAddress,\n      facilitatorUrl: config.facilitatorUrl,\n      rpcUrl: config.rpcUrl || getDefaultRpcUrl(config.network),\n      defaultToken: config.defaultToken || defaultToken,\n      middlewareConfig: config.middlewareConfig,\n    };\n\n    this.facilitatorClient = new FacilitatorClient(config.facilitatorUrl);\n  }\n\n  /**\n   * Extract payment header from request headers\n   * Pass in headers object from any framework (Next.js, Express, etc.)\n   */\n  extractPayment(headers: Record<string, string | string[] | undefined> | Headers): string | null {\n    // Handle Headers object (Next.js, Fetch API)\n    if (headers instanceof Headers) {\n      return headers.get(\"X-PAYMENT\") || headers.get(\"x-payment\");\n    }\n\n    // Handle plain object (Express, Fastify, etc.)\n    const xPayment = headers[\"X-PAYMENT\"] || headers[\"x-payment\"];\n    return Array.isArray(xPayment) ? xPayment[0] || null : xPayment || null;\n  }\n\n  /**\n   * Create payment requirements object from x402 RouteConfig\n   * @param routeConfig - x402 standard RouteConfig (price, network, config)\n   * @param resource - Optional resource URL override (uses config.resource if not provided)\n   */\n  async createPaymentRequirements(\n    routeConfig: RouteConfig,\n    resource?: string\n  ): Promise<PaymentRequirements> {\n    const feePayer = await this.facilitatorClient.getFeePayer(this.config.network);\n\n    // Extract SPLTokenAmount from price (supports Price union type)\n    const price = routeConfig.price as SPLTokenAmount;\n\n    // Merge config: routeConfig.config overrides server middlewareConfig defaults\n    const config = { ...this.config.middlewareConfig, ...routeConfig.config };\n\n    // Resource: use override if provided, otherwise use config.resource\n    const finalResource = resource || config.resource;\n    if (!finalResource) {\n      throw new Error(\"resource is required: provide either as parameter or in RouteConfig.config.resource\");\n    }\n\n    // Always include outputSchema field (required for facilitator discovery)\n    const paymentRequirements: PaymentRequirements = {\n      scheme: \"exact\",\n      network: routeConfig.network as typeof this.config.network,\n      maxAmountRequired: price.amount,\n      resource: finalResource,\n      description: config.description || \"Payment required\",\n      mimeType: config.mimeType || \"application/json\",\n      payTo: this.config.treasuryAddress,\n      maxTimeoutSeconds: config.maxTimeoutSeconds || 300,\n      asset: price.asset.address,\n      outputSchema: config.outputSchema || {},\n      extra: {\n        feePayer,\n      },\n    };\n\n    return paymentRequirements;\n  }\n\n  /**\n   * Create a 402 Payment Required response body\n   * Use this with your framework's response method\n   * @param requirements - Payment requirements (from createPaymentRequirements)\n   */\n  create402Response(requirements: PaymentRequirements): {\n    status: 402;\n    body: {\n      x402Version: number;\n      accepts: PaymentRequirements[];\n      error?: string;\n    };\n  } {\n    return {\n      status: 402,\n      body: {\n        x402Version: 1,\n        accepts: [requirements],\n        error: \"Payment required\",\n      },\n    };\n  }\n\n  /**\n   * Verify payment with facilitator\n   * @returns VerifyResponse with isValid and optional invalidReason\n   */\n  async verifyPayment(\n    paymentHeader: string,\n    paymentRequirements: PaymentRequirements\n  ): Promise<VerifyResponse> {\n    return this.facilitatorClient.verifyPayment(paymentHeader, paymentRequirements);\n  }\n\n  /**\n   * Settle payment with facilitator\n   * @returns SettleResponse with success status and optional errorReason\n   */\n  async settlePayment(\n    paymentHeader: string,\n    paymentRequirements: PaymentRequirements\n  ): Promise<SettleResponse> {\n    return this.facilitatorClient.settlePayment(paymentHeader, paymentRequirements);\n  }\n}\n\n"]}